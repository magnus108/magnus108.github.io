version: 2
jobs:
  build:
    working_directory: ~/futtetennismo
    docker:
      - image: futtetennista/hakyll:latest
    branches:
      only:
        - hakyll
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-stack-work-{{ checksum "magnus108-github-io.cabal" }}
      - run: stack build
      - save_cache:
          paths:
            - ~/magnus108.github.io/.stack-work
            - /root/.stack/
          key: v1-stack-work-{{ checksum "magnus108-github-io.cabal" }}
      - run: git submodule init
      - run: git submodule update
      - run: stack exec site rebuild
      - deploy:
          name: Deploy master to Github Pages
          command: |
            cd _site/ && git checkout master && git status
            git config --global user.email circleci@circleci.com
            git config --global user.name CircleCI
            git add --all
            git commit -m "Update (`date '+%F %T %Z'`) [ci skip]"
            git push origin master
